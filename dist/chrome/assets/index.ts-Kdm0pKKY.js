console.log("Bhaikaamdo Extension Background Service Worker Running");chrome.runtime.onInstalled.addListener(async()=>{console.log("Extension Installed"),chrome.sidePanel&&chrome.sidePanel.setPanelBehavior&&chrome.sidePanel.setPanelBehavior({openPanelOnActionClick:!0}),await l()});chrome.cookies.onChanged.addListener(e=>{e.cookie.domain.includes("bhaikaamdo.com")&&(e.cookie.name==="cf_auth"?l():e.cookie.name==="bhaikaamdo_defaultresume"&&(!e.removed&&e.cookie.value?chrome.storage.local.set({defaultResume:e.cookie.value}):chrome.storage.local.remove("defaultResume")))});chrome.runtime.onMessage.addListener((e,r,a)=>{if(e.type==="PING"&&a({type:"PONG"}),e.type==="GENERATE_RESUME_PDF"){const{resume:o,template:s}=e;return(async()=>{try{await u("src/offscreen/pdf.html");const t=await chrome.runtime.sendMessage({type:"GENERATE_PDF_OFFSCREEN",resume:o,template:s,target:"offscreen"});a(t)}catch(t){console.error("Background PDF Bridge Error:",t),a({success:!1,error:t.message||String(t)})}})(),!0}if(e.type==="GENERATE_COVER_LETTER_PDF"){const{delta:o,content:s}=e;return(async()=>{try{await u("src/offscreen/pdf.html");const t=await chrome.runtime.sendMessage({type:"GENERATE_COVER_LETTER_PDF_OFFSCREEN",delta:o,content:s,target:"offscreen"});a(t)}catch(t){console.error("Background Cover Letter PDF Bridge Error:",t),a({success:!1,error:t.message||String(t)})}})(),!0}if(e.action==="fetchMultipleDetails"){const{base:o,paths:s}=e;return(async()=>{try{if(!o||!s||!Array.isArray(s)){a({success:!1,message:"Missing base or paths"});return}const t={};for(const c of s){const m=`${o}/details/${c}/`;try{const n=await f(m);t[c]=n}catch(n){t[c]={success:!1,message:n.message||String(n)}}await new Promise(n=>setTimeout(n,1e3))}a({success:!0,results:t})}catch(t){a({success:!1,message:t.message||String(t)})}})(),!0}return!0});let i=null;async function u(e){(await chrome.runtime.getContexts({contextTypes:[chrome.runtime.ContextType.OFFSCREEN_DOCUMENT]})).length>0||(i?await i:(i=chrome.offscreen.createDocument({url:e,reasons:[chrome.offscreen.Reason.DOM_PARSER],justification:"Generate PDF using WebAssembly in a context that allows wasm-unsafe-eval"}),await i,i=null))}async function f(e){const a=(await chrome.tabs.create({url:e,active:!0})).id;try{await h(a,15e3);const o=await chrome.scripting.executeScript({target:{tabId:a},func:()=>{const t=document.querySelector("main");return t?t.innerHTML:null}});return{success:!0,html:o&&o[0]&&o[0].result?o[0].result:null}}catch(o){return{success:!1,message:o.message||String(o)}}finally{try{await chrome.tabs.remove(a)}catch{}}}function h(e,r=25e3){return new Promise((a,o)=>{const s=Date.now();function t(){chrome.tabs.get(e,c=>{if(!c)return o(new Error("Tab not found"));if(c.status==="complete"){setTimeout(a,3e3);return}if(Date.now()-s>r)return o(new Error("Timeout waiting for tab load"));setTimeout(t,500)})}t()})}async function l(){try{const e=await chrome.cookies.get({url:"https://bhaikaamdo.com",name:"cf_auth"});if(e&&e.value){const r=await d(e.value);r.success&&r.valid?await chrome.storage.local.set({token:e.value,careerforgeToken:e.value,username:r.username}):await chrome.storage.local.remove(["token","careerforgeToken","username"])}else await chrome.storage.local.remove(["token","careerforgeToken","username"]);try{const r=await chrome.cookies.get({url:"https://bhaikaamdo.com",name:"bhaikaamdo_defaultresume"});r&&r.value?await chrome.storage.local.set({defaultResume:r.value}):await chrome.storage.local.remove(["defaultResume"])}catch(r){console.warn("Error checking default resume cookie:",r)}}catch(e){console.error("Error checking cookie:",e)}}async function d(e){try{const r=await fetch("https://careerback.bhaikaamdo.com/api/checkExtensionToken",{method:"POST",headers:{"Content-Type":"application/json",Authorization:"Bearer "+e},body:JSON.stringify({token:e})}),a=await r.json();return r.ok&&a.success&&a.valid?{success:!0,valid:!0,username:a.username||""}:{success:!1,valid:!1,username:""}}catch(r){return console.error("Error validating token:",r),{success:!1,valid:!1,username:""}}}
